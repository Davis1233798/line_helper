From 4fcb5c42088f9933463326a8d939598b057724df Mon Sep 17 00:00:00 2001
From: Jack Chen <davis1233798@gmail.com>
Date: Mon, 30 Jun 2025 13:16:02 +0800
Subject: [PATCH] =?UTF-8?q?=E2=9C=A8=20=E5=A2=9E=E5=BC=B7=E6=97=A5?=
 =?UTF-8?q?=E6=9B=86=E5=8A=9F=E8=83=BD=EF=BC=9A=E6=99=BA=E6=85=A7=E4=BA=8B?=
 =?UTF-8?q?=E4=BB=B6=E9=A1=9E=E5=9E=8B=E8=AD=98=E5=88=A5=E3=80=81=E6=89=B9?=
 =?UTF-8?q?=E6=AC=A1=E8=99=95=E7=90=86=E3=80=81=E9=A1=8F=E8=89=B2=E5=88=86?=
 =?UTF-8?q?=E9=A1=9E=E8=88=87=E6=97=A5=E6=9B=86=E7=AE=A1=E7=90=86?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- æ–°å¢æ™ºæ…§äº‹ä»¶é¡å‹è­˜åˆ¥ï¼ˆdeadline, registration, start, end, participation, meeting, reminderï¼‰
- å¯¦ä½œæ‰¹æ¬¡è™•ç†å¤šå€‹äº‹ä»¶åˆ° Google Calendar
- æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šä¸åŒé¡è‰²å’Œæ™ºæ…§æé†’
- æ–°å¢æ—¥æ›† ID æŸ¥è©¢åŠŸèƒ½ï¼ˆè¼¸å…¥ã€Œæ—¥æ›†åˆ—è¡¨ã€æˆ–ã€Œæ—¥æ›†IDã€ï¼‰
- å¢å¼· LLM æ—¥æœŸæå–ï¼Œæ”¯æ´æ›´ç²¾ç¢ºçš„äº‹ä»¶åˆ†é¡
- æ”¹é€²ä½¿ç”¨è€…ä»‹é¢ï¼Œé¡¯ç¤ºäº‹ä»¶é¡å‹ emoji å’Œè©³ç´°è³‡è¨Š
- æ›´æ–° README æ–‡ä»¶èªªæ˜æ–°åŠŸèƒ½
---
 .serena/serena_config.yml             |   3 +
 README.md                             |  37 +++-
 src/index.js                          | 106 ++++++++++--
 src/services/googleCalendarManager.js | 236 ++++++++++++++++++++++++--
 src/services/llmParser.js             |  41 ++++-
 5 files changed, 383 insertions(+), 40 deletions(-)
 create mode 100644 .serena/serena_config.yml

diff --git a/.serena/serena_config.yml b/.serena/serena_config.yml
new file mode 100644
index 0000000..a19e0da
--- /dev/null
+++ b/.serena/serena_config.yml
@@ -0,0 +1,3 @@
+llm_model: "gemini-2.5-pro"
+llm_api_key: "AIzaSyD-9T2YzgFRFKJ4a11FwqWKU0JLWG-3hPM"
+llm_endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=AIzaSyD-9T2YzgFRFKJ4a11FwqWKU0JLWG-3hPM"
\ No newline at end of file
diff --git a/README.md b/README.md
index 6f8f8ff..abeb2d0 100644
--- a/README.md
+++ b/README.md
@@ -30,11 +30,16 @@
 - **åˆ†é¡æœå°‹**ï¼š`æŸ¥è©¢ [åˆ†é¡åç¨±]`
 - **çµ„åˆæœå°‹**ï¼š`æŸ¥è©¢ [åˆ†é¡] [é—œéµå­—]`
 
-### ğŸ“… è¡Œäº‹æ›†åŠŸèƒ½
+### ğŸ“… è¡Œäº‹æ›†åŠŸèƒ½ï¼ˆå¢å¼·ç‰ˆï¼‰
 - **æ™ºæ…§æ—¥æœŸæå–**ï¼šè‡ªå‹•è­˜åˆ¥ç¶²é ä¸­çš„é‡è¦æ—¥æœŸ
-- **Google Calendar**ï¼šè‡ªå‹•æ–°å¢äº‹ä»¶æˆ–æä¾›æ‰‹å‹•é€£çµ
-- **Apple æ—¥æ›†**ï¼šæä¾› ICS æª”æ¡ˆä¸‹è¼‰
-- **å¤šç¨®æ ¼å¼æ”¯æ´**ï¼šè™•ç†å„ç¨®æ—¥æœŸæ™‚é–“æ ¼å¼
+- **äº‹ä»¶é¡å‹è­˜åˆ¥**ï¼šè‡ªå‹•åˆ†é¡ç‚ºæˆªæ­¢æ—¥æœŸã€å ±åæ—¥æœŸã€é–‹å§‹æ—¥æœŸã€çµæŸæ—¥æœŸã€åƒåŠ æ—¥æœŸç­‰
+- **Google Calendar æ•´åˆ**ï¼š
+  - è‡ªå‹•æ–°å¢äº‹ä»¶åˆ°æŒ‡å®šæ—¥æ›†
+  - æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šä¸åŒé¡è‰²å’Œæé†’
+  - æ‰¹æ¬¡è™•ç†å¤šå€‹äº‹ä»¶
+  - æ™ºæ…§æé†’è¨­å®šï¼ˆæˆªæ­¢æ—¥æœŸæå‰1å¤©+2å°æ™‚+15åˆ†é˜æé†’ï¼‰
+- **Apple æ—¥æ›†æ”¯æ´**ï¼šæä¾› ICS æª”æ¡ˆä¸‹è¼‰
+- **æ—¥æ›†ç®¡ç†**ï¼šè¼¸å…¥ã€Œæ—¥æ›†åˆ—è¡¨ã€æˆ–ã€Œæ—¥æ›†IDã€æŸ¥è©¢å¯ç”¨çš„ Google Calendar
 
 ## ğŸ”§ æŠ€è¡“æ¶æ§‹
 
@@ -132,9 +137,27 @@ npm run dev
 
 ### è¡Œäº‹æ›†åŠŸèƒ½
 ç•¶è¨Šæ¯åŒ…å«æ—¥æœŸè³‡è¨Šæ™‚ï¼Œæ©Ÿå™¨äººæœƒï¼š
-1. è‡ªå‹•æå–é‡è¦æ—¥æœŸ
-2. å˜—è©¦æ–°å¢åˆ° Google Calendar
-3. æä¾› Apple æ—¥æ›†ä¸‹è¼‰é€£çµ
+1. **æ™ºæ…§è­˜åˆ¥äº‹ä»¶é¡å‹**ï¼š
+   - â° æˆªæ­¢æ—¥æœŸï¼ˆdeadlineï¼‰
+   - ğŸ“ å ±åæ—¥æœŸï¼ˆregistrationï¼‰
+   - ğŸš€ é–‹å§‹æ—¥æœŸï¼ˆstartï¼‰
+   - ğŸ çµæŸæ—¥æœŸï¼ˆendï¼‰
+   - ğŸ¯ åƒåŠ æ—¥æœŸï¼ˆparticipationï¼‰
+   - ğŸ‘¥ æœƒè­°ï¼ˆmeetingï¼‰
+   - ğŸ”” æé†’äº‹é …ï¼ˆreminderï¼‰
+
+2. **è‡ªå‹•æ–°å¢åˆ° Google Calendar**ï¼š
+   - æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šä¸åŒé¡è‰²
+   - æ™ºæ…§æé†’è¨­å®šï¼ˆæˆªæ­¢æ—¥æœŸå¤šé‡æé†’ï¼‰
+   - æ‰¹æ¬¡è™•ç†å¤šå€‹äº‹ä»¶
+
+3. **æä¾› Apple æ—¥æ›†ä¸‹è¼‰**ï¼šICS æª”æ¡ˆæ ¼å¼
+
+### æ—¥æ›†ç®¡ç†æŒ‡ä»¤
+```
+æ—¥æ›†åˆ—è¡¨        # æŸ¥è©¢æ‰€æœ‰å¯ç”¨çš„ Google Calendar
+æ—¥æ›†ID          # é¡¯ç¤ºæ—¥æ›† ID å’Œä½¿ç”¨èªªæ˜
+```
 
 ## ğŸ› ï¸ API ç«¯é»
 
diff --git a/src/index.js b/src/index.js
index 9206766..03e0875 100644
--- a/src/index.js
+++ b/src/index.js
@@ -193,6 +193,58 @@ app.post('/webhook-raw', express.raw({type: 'application/json'}), (req, res) =>
   }
 });
 
+// è™•ç†æ—¥æ›†åˆ—è¡¨æŸ¥è©¢
+async function handleCalendarListQuery(event) {
+  try {
+    console.log('ğŸ“… ç”¨æˆ¶è«‹æ±‚æŸ¥è©¢ Google Calendar åˆ—è¡¨');
+    
+    const calendars = await googleCalendarManager.listCalendars();
+    
+    if (calendars.length === 0) {
+      return client.replyMessage(event.replyToken, {
+        type: 'text',
+        text: 'âŒ ç„¡æ³•å–å¾—æ—¥æ›†åˆ—è¡¨ï¼Œè«‹ç¢ºèªï¼š\n1. Google Calendar API æ†‘è­‰æ˜¯å¦æ­£ç¢ºè¨­å®š\n2. æœå‹™å¸³è™Ÿæ˜¯å¦æœ‰å­˜å–æ¬Šé™\n3. GOOGLE_CREDENTIALS_JSON ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®šæ­£ç¢º',
+      });
+    }
+
+    let replyMessage = 'ğŸ“… æ‚¨çš„ Google Calendar åˆ—è¡¨ï¼š\n\n';
+    
+    calendars.forEach((cal, index) => {
+      replyMessage += `${index + 1}. ${cal.name}\n`;
+      replyMessage += `   ğŸ“§ ID: ${cal.id}\n`;
+      if (cal.primary) {
+        replyMessage += `   â­ ä¸»è¦æ—¥æ›†\n`;
+      }
+      if (cal.description) {
+        replyMessage += `   ğŸ“ ${cal.description}\n`;
+      }
+      replyMessage += `   ğŸ”‘ æ¬Šé™: ${cal.accessRole}\n\n`;
+    });
+
+    replyMessage += 'ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š\n';
+    replyMessage += '1. è¤‡è£½æ‚¨æƒ³è¦çš„æ—¥æ›† ID\n';
+    replyMessage += '2. åœ¨ Render ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š GOOGLE_CALENDAR_ID\n';
+    replyMessage += '3. é‡æ–°éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼å³å¯è‡ªå‹•æ–°å¢äº‹ä»¶è‡³è©²æ—¥æ›†';
+
+    // æª¢æŸ¥è¨Šæ¯é•·åº¦
+    if (replyMessage.length > 5000) {
+      replyMessage = replyMessage.substring(0, 4950) + '\n...ï¼ˆåˆ—è¡¨éé•·ï¼Œéƒ¨åˆ†å…§å®¹å·²çœç•¥ï¼‰';
+    }
+
+    return client.replyMessage(event.replyToken, {
+      type: 'text',
+      text: replyMessage,
+    });
+
+  } catch (error) {
+    console.error('è™•ç†æ—¥æ›†åˆ—è¡¨æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
+    return client.replyMessage(event.replyToken, {
+      type: 'text',
+      text: 'âŒ æŸ¥è©¢æ—¥æ›†åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nå¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹æª¢æŸ¥ Google Calendar API è¨­å®šã€‚',
+    });
+  }
+}
+
 // è™•ç†æœå°‹æŸ¥è©¢
 async function handleSearchQuery(event, userMessage) {
   try {
@@ -340,6 +392,12 @@ async function handleEvent(event) {
       return;
     }
 
+    // è™•ç†æ—¥æ›†ç®¡ç†æŒ‡ä»¤
+    if (userMessage.includes('æ—¥æ›†') && (userMessage.includes('åˆ—è¡¨') || userMessage.includes('æ¸…å–®') || userMessage.includes('ID'))) {
+      await handleCalendarListQuery(event);
+      return;
+    }
+
     // å¦‚æœä¸æ˜¯æœå°‹æŸ¥è©¢ï¼Œç¹¼çºŒé€²è¡Œè§£æå’Œå„²å­˜
     const parsedInfo = await llmParser.parseMessage(userMessage);
 
@@ -357,32 +415,58 @@ async function handleEvent(event) {
     if (notionResult.success) {
       let replyMessage = `âœ… å·²æˆåŠŸå„²å­˜ï¼š${notionResult.title}\n${notionResult.url}`;
 
-      // è™•ç†æ—¥æ›†äº‹ä»¶ä¸¦ç”¢ç”Ÿé€£çµ
+      // ã€å¢å¼·ã€‘è™•ç†æ—¥æ›†äº‹ä»¶ä¸¦ç”¢ç”Ÿé€£çµ - æ”¯æ´å¤šç¨®äº‹ä»¶é¡å‹
       if (parsedInfo.events && parsedInfo.events.length > 0) {
         replyMessage += '\n\nğŸ“… ç™¼ç¾é‡è¦æ—¥æœŸï¼š';
 
+        // æ‰¹æ¬¡æ–°å¢åˆ° Google Calendar
+        const googleBatchResults = await googleCalendarManager.addMultipleEvents(parsedInfo.events);
+
         for (const [index, calEvent] of parsedInfo.events.entries()) {
-          replyMessage += `\n\n${index + 1}. ${calEvent.title} - ${calEvent.description}`;
+          const eventTypeEmoji = {
+            'deadline': 'â°',
+            'registration': 'ğŸ“',
+            'start': 'ğŸš€',
+            'end': 'ğŸ',
+            'participation': 'ğŸ¯',
+            'meeting': 'ğŸ‘¥',
+            'reminder': 'ğŸ””',
+            'event': 'ğŸ“…'
+          };
 
-          // å˜—è©¦è‡ªå‹•æ–°å¢åˆ° Google Calendar
-          const googleCalResult = await googleCalendarManager.addEventToCalendar(calEvent);
+          const emoji = eventTypeEmoji[calEvent.type] || 'ğŸ“…';
+          const googleResult = googleBatchResults[index];
+          
+          replyMessage += `\n\n${index + 1}. ${emoji} [${googleResult?.category || calEvent.type}] ${calEvent.title}`;
+          replyMessage += `\n   ğŸ“… ${calEvent.date.toLocaleString('zh-TW')}`;
+          
+          if (calEvent.description && calEvent.description !== calEvent.title) {
+            replyMessage += `\n   ğŸ“ ${calEvent.description.substring(0, 50)}${calEvent.description.length > 50 ? '...' : ''}`;
+          }
 
-          if (googleCalResult.success) {
-            replyMessage += `\nâœ… å·²è‡ªå‹•æ–°å¢è‡³Googleæ—¥æ›†`;
-            if (googleCalResult.url) {
-              replyMessage += `\nğŸ”— æŸ¥çœ‹Googleæ—¥æ›†: ${googleCalResult.url}`;
+          // Google Calendar çµæœ
+          if (googleResult?.success) {
+            replyMessage += `\n   âœ… å·²è‡ªå‹•æ–°å¢è‡³ Google æ—¥æ›†`;
+            if (googleResult.url) {
+              replyMessage += `\n   ğŸ”— æŸ¥çœ‹: ${googleResult.url}`;
             }
           } else {
             // è‡ªå‹•æ–°å¢å¤±æ•—ï¼Œæä¾›æ‰‹å‹•é€£çµ
-            replyMessage += `\nâš ï¸  ç„¡æ³•è‡ªå‹•æ–°å¢è‡³Googleæ—¥æ›†`;
+            replyMessage += `\n   âš ï¸  Google æ—¥æ›†: ${googleResult?.message || 'æ–°å¢å¤±æ•—'}`;
             const googleLink = llmParser.generateGoogleCalendarLink(calEvent);
-            replyMessage += `\nğŸ”— æ‰‹å‹•æ–°å¢Googleæ—¥æ›†: ${googleLink}`;
+            replyMessage += `\n   ğŸ”— æ‰‹å‹•æ–°å¢: ${googleLink}`;
           }
 
           // ç”¢ç”Ÿ Apple æ—¥æ›†ä¸‹è¼‰é€£çµ
           const eventId = `${Date.now()}-${index}`;
           const downloadUrl = `${process.env.BASE_URL || 'https://your-render-url.com'}/download-ics/${eventId}?title=${encodeURIComponent(calEvent.title)}&description=${encodeURIComponent(calEvent.description)}&date=${calEvent.date.toISOString()}`;
-          replyMessage += `\nğŸ ä¸‹è¼‰Appleæ—¥æ›†: ${downloadUrl}`;
+          replyMessage += `\n   ğŸ Apple æ—¥æ›†: ${downloadUrl}`;
+        }
+
+        // é¡¯ç¤ºæ‰¹æ¬¡è™•ç†çµ±è¨ˆ
+        const successCount = googleBatchResults.filter(r => r.success).length;
+        if (parsedInfo.events.length > 1) {
+          replyMessage += `\n\nğŸ“Š æ‰¹æ¬¡è™•ç†çµæœ: ${successCount}/${parsedInfo.events.length} å€‹äº‹ä»¶æˆåŠŸæ–°å¢è‡³ Google æ—¥æ›†`;
         }
       }
 
diff --git a/src/services/googleCalendarManager.js b/src/services/googleCalendarManager.js
index 6a6f66b..315a309 100644
--- a/src/services/googleCalendarManager.js
+++ b/src/services/googleCalendarManager.js
@@ -41,24 +41,153 @@ if (process.env.GOOGLE_CREDENTIALS_JSON) {
 const calendar = google.calendar({ version: 'v3', auth });
 
 /**
- * ç›´æ¥æ–°å¢äº‹ä»¶åˆ° Google Calendar
- * @param {object} event - åŒ…å«äº‹ä»¶è³‡è¨Šçš„ç‰©ä»¶ { title, description, date }
+ * åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¥æ›† ID
+ * @returns {Promise<Array>} - åŒ…å«æ‰€æœ‰æ—¥æ›†è³‡è¨Šçš„é™£åˆ—
+ */
+async function listCalendars() {
+  if (!auth) {
+    console.warn('æœªè¨­å®šèªè­‰ï¼Œç„¡æ³•åˆ—å‡ºæ—¥æ›†');
+    return [];
+  }
+  
+  try {
+    const res = await calendar.calendarList.list();
+    const calendars = res.data.items;
+    
+    console.log('ğŸ“… å¯ç”¨çš„æ—¥æ›†ï¼š');
+    calendars.forEach((cal) => {
+      console.log(`  â€¢ ${cal.summary}: ${cal.id}`);
+    });
+    
+    return calendars.map(cal => ({
+      id: cal.id,
+      name: cal.summary,
+      description: cal.description || '',
+      primary: cal.primary || false,
+      accessRole: cal.accessRole
+    }));
+  } catch (error) {
+    console.error('å–å¾—æ—¥æ›†æ¸…å–®å¤±æ•—:', error);
+    return [];
+  }
+}
+
+/**
+ * æ ¹æ“šäº‹ä»¶é¡å‹æ±ºå®šäº‹ä»¶é¡è‰²å’Œåˆ†é¡
+ * @param {string} eventType - äº‹ä»¶é¡å‹ (deadline, registration, start, end, etc.)
+ * @returns {object} - åŒ…å«é¡è‰²å’Œåˆ†é¡è³‡è¨Š
+ */
+function getEventStyle(eventType) {
+  const eventStyles = {
+    'deadline': { colorId: '11', category: 'æˆªæ­¢æ—¥æœŸ' }, // ç´…è‰²
+    'registration': { colorId: '9', category: 'å ±åæ—¥æœŸ' }, // è—è‰²
+    'start': { colorId: '10', category: 'é–‹å§‹æ—¥æœŸ' }, // ç¶ è‰²
+    'end': { colorId: '6', category: 'çµæŸæ—¥æœŸ' }, // æ©™è‰²
+    'participation': { colorId: '5', category: 'åƒåŠ æ—¥æœŸ' }, // é»ƒè‰²
+    'reminder': { colorId: '1', category: 'æé†’äº‹é …' }, // æ·¡è—è‰²
+    'meeting': { colorId: '7', category: 'æœƒè­°' }, // é’è‰²
+    'event': { colorId: '2', category: 'æ´»å‹•' }, // æ·¡ç¶ è‰²
+    'default': { colorId: '1', category: 'å…¶ä»–' }
+  };
+  
+  return eventStyles[eventType] || eventStyles['default'];
+}
+
+/**
+ * æ™ºèƒ½åˆ¤æ–·äº‹ä»¶é¡å‹
+ * @param {string} title - äº‹ä»¶æ¨™é¡Œ
+ * @param {string} description - äº‹ä»¶æè¿°
+ * @returns {string} - äº‹ä»¶é¡å‹
+ */
+function detectEventType(title, description = '') {
+  const content = (title + ' ' + description).toLowerCase();
+  
+  // æˆªæ­¢æ—¥æœŸç›¸é—œé—œéµå­—
+  if (content.includes('æˆªæ­¢') || content.includes('deadline') || content.includes('due') || 
+      content.includes('æœ€å¾Œ') || content.includes('çµæŸå ±å') || content.includes('ç”³è«‹æˆªæ­¢')) {
+    return 'deadline';
+  }
+  
+  // å ±åç›¸é—œé—œéµå­—
+  if (content.includes('å ±å') || content.includes('è¨»å†Š') || content.includes('registration') || 
+      content.includes('ç”³è«‹') || content.includes('ç™»è¨˜') || content.includes('å ±åé–‹å§‹')) {
+    return 'registration';
+  }
+  
+  // é–‹å§‹æ—¥æœŸç›¸é—œé—œéµå­—
+  if (content.includes('é–‹å§‹') || content.includes('start') || content.includes('é–‹å¹•') || 
+      content.includes('å•Ÿå‹•') || content.includes('ä¸Šç·š') || content.includes('ç™¼å¸ƒ')) {
+    return 'start';
+  }
+  
+  // çµæŸæ—¥æœŸç›¸é—œé—œéµå­—
+  if (content.includes('çµæŸ') || content.includes('end') || content.includes('é–‰å¹•') || 
+      content.includes('å®Œæˆ') || content.includes('ä¸‹ç·š')) {
+    return 'end';
+  }
+  
+  // åƒåŠ æ—¥æœŸç›¸é—œé—œéµå­—
+  if (content.includes('åƒåŠ ') || content.includes('å‡ºå¸­') || content.includes('attend') || 
+      content.includes('åƒèˆ‡') || content.includes('æ´»å‹•æ—¥') || content.includes('èˆ‰è¾¦')) {
+    return 'participation';
+  }
+  
+  // æœƒè­°ç›¸é—œé—œéµå­—
+  if (content.includes('æœƒè­°') || content.includes('meeting') || content.includes('è¨è«–') || 
+      content.includes('åº§è«‡') || content.includes('ç ”è¨')) {
+    return 'meeting';
+  }
+  
+  return 'event';
+}
+
+/**
+ * å¢å¼·ç‰ˆæ–°å¢äº‹ä»¶åˆ° Google Calendar
+ * @param {object} event - åŒ…å«äº‹ä»¶è³‡è¨Šçš„ç‰©ä»¶ { title, description, date, type? }
+ * @param {string} calendarId - æŒ‡å®šçš„æ—¥æ›†IDï¼Œå¦‚æœä¸æä¾›å‰‡ä½¿ç”¨é è¨­
  * @returns {Promise<object>} - åŒ…å«æˆåŠŸè³‡è¨Šå’Œäº‹ä»¶é€£çµ
  */
-async function addEventToCalendar(event) {
-  if (!auth || !CALENDAR_ID) {
-    console.warn('æœªè¨­å®š GOOGLE_CALENDAR_ID æˆ–èªè­‰å¤±æ•—ï¼Œè·³éè‡ªå‹•æ–°å¢äº‹ä»¶');
-    return { success: false, message: 'æœªè¨­å®š GOOGLE_CALENDAR_ID æˆ–èªè­‰å¤±æ•—' };
+async function addEventToCalendar(event, calendarId = null) {
+  if (!auth) {
+    console.warn('æœªè¨­å®šèªè­‰ï¼Œè·³éè‡ªå‹•æ–°å¢äº‹ä»¶');
+    return { success: false, message: 'æœªè¨­å®šèªè­‰' };
+  }
+  
+  const targetCalendarId = calendarId || CALENDAR_ID;
+  if (!targetCalendarId) {
+    console.warn('æœªè¨­å®š GOOGLE_CALENDAR_IDï¼Œè·³éè‡ªå‹•æ–°å¢äº‹ä»¶');
+    return { success: false, message: 'æœªè¨­å®š GOOGLE_CALENDAR_ID' };
   }
   
   try {
     const eventStartTime = new Date(event.date);
-    // é è¨­äº‹ä»¶é•·åº¦ç‚º1å°æ™‚
-    const eventEndTime = new Date(eventStartTime.getTime() + 60 * 60 * 1000);
+    
+    // æ™ºèƒ½åˆ¤æ–·äº‹ä»¶é¡å‹
+    const eventType = event.type || detectEventType(event.title, event.description);
+    const eventStyle = getEventStyle(eventType);
+    
+    // æ ¹æ“šäº‹ä»¶é¡å‹èª¿æ•´äº‹ä»¶é•·åº¦
+    let eventDuration = 60; // é è¨­1å°æ™‚
+    if (eventType === 'deadline') {
+      eventDuration = 15; // æˆªæ­¢æ—¥æœŸåªéœ€15åˆ†é˜æé†’
+    } else if (eventType === 'meeting') {
+      eventDuration = 90; // æœƒè­°é è¨­1.5å°æ™‚
+    } else if (eventType === 'participation') {
+      eventDuration = 180; // åƒåŠ æ´»å‹•é è¨­3å°æ™‚
+    }
+    
+    const eventEndTime = new Date(eventStartTime.getTime() + eventDuration * 60 * 1000);
+
+    // å¢å¼·äº‹ä»¶æè¿°
+    const enhancedDescription = `${eventStyle.category}: ${event.description || event.title}
+    
+äº‹ä»¶é¡å‹: ${eventStyle.category}
+å»ºç«‹æ™‚é–“: ${new Date().toLocaleString('zh-TW')}
+è‡ªå‹•åˆ†é¡: ${eventType}`;
 
     const calendarEvent = {
-      summary: event.title,
-      description: event.description,
+      summary: `[${eventStyle.category}] ${event.title}`,
+      description: enhancedDescription,
       start: {
         dateTime: eventStartTime.toISOString(),
         timeZone: 'Asia/Taipei',
@@ -67,18 +196,26 @@ async function addEventToCalendar(event) {
         dateTime: eventEndTime.toISOString(),
         timeZone: 'Asia/Taipei',
       },
+      colorId: eventStyle.colorId,
+      // æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šæé†’
+      reminders: {
+        useDefault: false,
+        overrides: getEventReminders(eventType)
+      }
     };
 
     const response = await calendar.events.insert({
-      calendarId: CALENDAR_ID,
+      calendarId: targetCalendarId,
       resource: calendarEvent,
     });
     
-    console.log('æˆåŠŸæ–°å¢äº‹ä»¶åˆ° Google Calendar:', response.data.summary);
+    console.log(`âœ… æˆåŠŸæ–°å¢${eventStyle.category}åˆ° Google Calendar: ${event.title}`);
     return {
       success: true,
-      message: 'å·²è‡ªå‹•æ–°å¢è‡³ Google Calendar',
+      message: `å·²è‡ªå‹•æ–°å¢${eventStyle.category}è‡³ Google Calendar`,
       url: response.data.htmlLink,
+      eventType: eventType,
+      category: eventStyle.category
     };
   } catch (error) {
     console.error('æ–°å¢äº‹ä»¶åˆ° Google Calendar å¤±æ•—:', error.message);
@@ -89,6 +226,79 @@ async function addEventToCalendar(event) {
   }
 }
 
+/**
+ * æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šæé†’
+ * @param {string} eventType - äº‹ä»¶é¡å‹
+ * @returns {Array} - æé†’è¨­å®šé™£åˆ—
+ */
+function getEventReminders(eventType) {
+  const reminderSettings = {
+    'deadline': [
+      { method: 'popup', minutes: 60 * 24 }, // 1å¤©å‰
+      { method: 'popup', minutes: 60 * 2 },  // 2å°æ™‚å‰
+      { method: 'popup', minutes: 15 }       // 15åˆ†é˜å‰
+    ],
+    'registration': [
+      { method: 'popup', minutes: 60 * 24 }, // 1å¤©å‰
+      { method: 'popup', minutes: 60 }       // 1å°æ™‚å‰
+    ],
+    'meeting': [
+      { method: 'popup', minutes: 15 },      // 15åˆ†é˜å‰
+      { method: 'popup', minutes: 5 }        // 5åˆ†é˜å‰
+    ],
+    'participation': [
+      { method: 'popup', minutes: 60 * 24 }, // 1å¤©å‰
+      { method: 'popup', minutes: 60 }       // 1å°æ™‚å‰
+    ],
+    'default': [
+      { method: 'popup', minutes: 15 }       // 15åˆ†é˜å‰
+    ]
+  };
+  
+  return reminderSettings[eventType] || reminderSettings['default'];
+}
+
+/**
+ * æ‰¹æ¬¡æ–°å¢å¤šå€‹äº‹ä»¶åˆ° Google Calendar
+ * @param {Array} events - äº‹ä»¶é™£åˆ—
+ * @param {string} calendarId - æŒ‡å®šçš„æ—¥æ›†ID
+ * @returns {Promise<Array>} - è™•ç†çµæœé™£åˆ—
+ */
+async function addMultipleEvents(events, calendarId = null) {
+  if (!events || events.length === 0) {
+    return [];
+  }
+  
+  console.log(`ğŸ“… é–‹å§‹æ‰¹æ¬¡æ–°å¢ ${events.length} å€‹äº‹ä»¶åˆ° Google Calendar`);
+  
+  const results = [];
+  for (const event of events) {
+    try {
+      const result = await addEventToCalendar(event, calendarId);
+      results.push({ event: event.title, ...result });
+      
+      // é¿å…APIé€Ÿç‡é™åˆ¶
+      await new Promise(resolve => setTimeout(resolve, 100));
+    } catch (error) {
+      console.error(`æ–°å¢äº‹ä»¶å¤±æ•—: ${event.title}`, error);
+      results.push({ 
+        event: event.title, 
+        success: false, 
+        message: error.message 
+      });
+    }
+  }
+  
+  const successCount = results.filter(r => r.success).length;
+  console.log(`ğŸ“… æ‰¹æ¬¡æ–°å¢å®Œæˆ: ${successCount}/${events.length} å€‹äº‹ä»¶æˆåŠŸ`);
+  
+  return results;
+}
+
 module.exports = {
   addEventToCalendar,
+  addMultipleEvents,
+  listCalendars,
+  detectEventType,
+  getEventStyle
 }; 
\ No newline at end of file
diff --git a/src/services/llmParser.js b/src/services/llmParser.js
index 67c0b7d..2078e86 100644
--- a/src/services/llmParser.js
+++ b/src/services/llmParser.js
@@ -118,21 +118,38 @@ const CATEGORY_TAGS = {
   "æ—…éŠ": ["æ—…éŠè¦åŠƒ", "ä½å®¿é è¨‚", "äº¤é€š", "åœ°åœ–"]
 };
 
-// ã€æ–°ã€‘ä½¿ç”¨ LLM æå–æ—¥æœŸå’Œæ™‚é–“è³‡è¨Š
+// ã€å¢å¼·ã€‘ä½¿ç”¨ LLM æå–æ—¥æœŸå’Œæ™‚é–“è³‡è¨Šï¼Œæ”¯æ´å¤šç¨®äº‹ä»¶é¡å‹
 async function extractDateTimeInfo(websiteData) {
   const content = `${websiteData.title}\n${websiteData.description}\n${websiteData.rawContent.substring(0, 15000)}`;
   
   const prompt = `
     ä½ æ˜¯ä¸€å€‹å°ˆé–€å¾æ–‡æœ¬ä¸­æå–äº‹ä»¶å’Œæ—¥æœŸçš„AIåŠ©ç†ã€‚è«‹ä»”ç´°é–±è®€ä»¥ä¸‹ç¶²ç«™å…§å®¹ï¼Œæ‰¾å‡ºæ‰€æœ‰é‡è¦çš„æ—¥æœŸå’Œæ™‚é–“ã€‚
-    å°æ–¼æ¯ä¸€å€‹æ‰¾åˆ°çš„äº‹ä»¶ï¼Œè«‹æä¾›ä¸€å€‹ç°¡çŸ­çš„æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šã€Œå ±åæˆªæ­¢ã€ã€ã€Œæ´»å‹•é–‹å§‹ã€ï¼‰å’Œä¸€å€‹ç²¾ç¢ºçš„æ—¥æœŸæ™‚é–“ã€‚
+    å°æ–¼æ¯ä¸€å€‹æ‰¾åˆ°çš„äº‹ä»¶ï¼Œè«‹æä¾›æ¨™é¡Œã€äº‹ä»¶é¡å‹ã€å’Œç²¾ç¢ºçš„æ—¥æœŸæ™‚é–“ã€‚
+    
+    äº‹ä»¶é¡å‹åˆ†é¡ï¼š
+    - "deadline": æˆªæ­¢æ—¥æœŸã€ç”³è«‹æˆªæ­¢ã€å ±åæˆªæ­¢ã€æœ€å¾ŒæœŸé™
+    - "registration": å ±åé–‹å§‹ã€è¨»å†Šé–‹æ”¾ã€ç”³è«‹é–‹å§‹ã€ç™»è¨˜é–‹å§‹
+    - "start": æ´»å‹•é–‹å§‹ã€é–‹å¹•ã€å•Ÿå‹•ã€ä¸Šç·šã€ç™¼å¸ƒ
+    - "end": æ´»å‹•çµæŸã€é–‰å¹•ã€å®Œæˆã€ä¸‹ç·š
+    - "participation": åƒåŠ æ—¥æœŸã€å‡ºå¸­æ—¥æœŸã€æ´»å‹•èˆ‰è¾¦æ—¥
+    - "meeting": æœƒè­°ã€åº§è«‡æœƒã€ç ”è¨æœƒã€è¨è«–æœƒ
+    - "reminder": æé†’äº‹é …ã€é‡è¦é€šçŸ¥
+    - "event": å…¶ä»–ä¸€èˆ¬äº‹ä»¶
     
     è¦å‰‡ï¼š
-    1.  åªå›å‚³æœ‰æ•ˆçš„ã€æœªä¾†çš„æ—¥æœŸã€‚å¿½ç•¥éå»çš„æ—¥æœŸã€‚
-    2.  å¦‚æœå¹´ä»½ä¸æ˜ç¢ºï¼Œè«‹æ ¹æ“šç•¶å‰å¹´ä»½ï¼ˆ${new Date().getFullYear()}ï¼‰é€²è¡Œæ¨æ–·ã€‚
-    3.  å¦‚æœåªæåˆ°æ—¥æœŸä½†æ²’æœ‰æ™‚é–“ï¼Œè«‹å°‡æ™‚é–“é è¨­ç‚ºç•¶å¤©çš„ 23:59ã€‚
-    4.  å°‡æå–çš„æ—¥æœŸå’Œæ™‚é–“è½‰æ›ç‚º "YYYY-MM-DDTHH:mm:ss" çš„ ISO 8601 æ ¼å¼ã€‚
-    5.  æœ€çµ‚çµæœå¿…é ˆæ˜¯ JSON æ ¼å¼çš„é™£åˆ—ï¼Œæ ¼å¼ç‚ºï¼š[{"title": "äº‹ä»¶æ¨™é¡Œ", "iso_datetime": "YYYY-MM-DDTHH:mm:ss", "description": "äººé¡å¯è®€çš„æè¿°"}]ã€‚
-    6.  å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆæ—¥æœŸï¼Œè«‹å›å‚³ä¸€å€‹ç©ºé™£åˆ— []ã€‚
+    1. åªå›å‚³æœ‰æ•ˆçš„ã€æœªä¾†çš„æ—¥æœŸã€‚å¿½ç•¥éå»çš„æ—¥æœŸã€‚
+    2. å¦‚æœå¹´ä»½ä¸æ˜ç¢ºï¼Œè«‹æ ¹æ“šç•¶å‰å¹´ä»½ï¼ˆ${new Date().getFullYear()}ï¼‰é€²è¡Œæ¨æ–·ã€‚
+    3. å¦‚æœåªæåˆ°æ—¥æœŸä½†æ²’æœ‰æ™‚é–“ï¼Œè«‹æ ¹æ“šäº‹ä»¶é¡å‹è¨­å®šåˆç†æ™‚é–“ï¼š
+       - deadline: 23:59
+       - registration: 09:00
+       - start/meeting: 10:00
+       - end: 18:00
+       - participation: 14:00
+       - å…¶ä»–: 12:00
+    4. å°‡æå–çš„æ—¥æœŸå’Œæ™‚é–“è½‰æ›ç‚º "YYYY-MM-DDTHH:mm:ss" çš„ ISO 8601 æ ¼å¼ã€‚
+    5. æœ€çµ‚çµæœå¿…é ˆæ˜¯ JSON æ ¼å¼çš„é™£åˆ—ï¼Œæ ¼å¼ç‚ºï¼š
+       [{"title": "äº‹ä»¶æ¨™é¡Œ", "type": "äº‹ä»¶é¡å‹", "iso_datetime": "YYYY-MM-DDTHH:mm:ss", "description": "è©³ç´°æè¿°"}]
+    6. å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆæ—¥æœŸï¼Œè«‹å›å‚³ä¸€å€‹ç©ºé™£åˆ— []ã€‚
 
     ç¶²ç«™å…§å®¹å¦‚ä¸‹ï¼š
     """
@@ -162,7 +179,7 @@ async function extractDateTimeInfo(websiteData) {
           // å†æ¬¡ç¢ºèªæ—¥æœŸæ˜¯æœ‰æ•ˆçš„ä¸¦ä¸”æ˜¯æœªä¾†çš„
           if (!isNaN(eventDate.getTime()) && eventDate > new Date()) {
             events.push({
-              type: 'deadline', // ä¿æŒé¡å‹ä¸€è‡´
+              type: ev.type || 'event', // ä½¿ç”¨ LLM åˆ¤æ–·çš„äº‹ä»¶é¡å‹
               title: ev.title,
               date: eventDate,
               description: ev.description || `${ev.title}: ${eventDate.toLocaleString('zh-TW')}`
@@ -171,6 +188,12 @@ async function extractDateTimeInfo(websiteData) {
         }
       }
     }
+    
+    console.log(`ğŸ“… å¾ç¶²ç«™å…§å®¹ä¸­æå–åˆ° ${events.length} å€‹äº‹ä»¶`);
+    events.forEach(event => {
+      console.log(`  â€¢ [${event.type}] ${event.title} - ${event.date.toLocaleString('zh-TW')}`);
+    });
+    
     return events;
   } catch (error) {
     console.error('ä½¿ç”¨ LLM æå–æ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
-- 
2.49.0

